print("Hello!!!!")

local Players = game:GetService("Players")
local Interiors = workspace:WaitForChild("Interiors")
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService("VirtualUser")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local VirtualInputManager = game:GetService("VirtualInputManager")
local UserInputService = game:GetService("UserInputService")

local mainMap = nil
task.spawn(function()
    local success, result = pcall(function() return Interiors:WaitForChild("MainMap!Christmas", 5) end)
    if success and result then
        mainMap = result
        print("MainMap found and loaded!")
    else
        warn("MainMap!Christmas not found immediately. Searching alternatives...")
        for _, child in pairs(Interiors:GetChildren()) do
            if child.Name:find("MainMap") then
                mainMap = child
                print("Found map: " .. child.Name)
                break
            end
        end
    end
end)
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")

-- // CONFIGURATION DEFAULTS \\ --
getgenv().g_autofarmgingerbread = false 
getgenv().g_autocollect = true 
local webhookUrl = ""

local visited = {}
local current = nil
local pickupStartTime = 0 
local didAutoCollectThisEmpty = false

-- // CURRENCY TRACKING VARIABLES \\ --
local startCurrency = nil 
local currentCurrencyValue = 0
local gainedCurrency = 0
local lastTrackedCurrency = nil -- For detecting currency changes

-- // SOURCE TRACKING VARIABLES \\ --
local gainedFromCollection = 0
local gainedFromTrain = 0
local currentSource = "none" -- "collection", "train", or "none"

-- // TIME TRACKING VARIABLES \\ --
local startTime = tick() -- Records the exact time the script loaded

local collectCFrame = CFrame.new(
    -286.743164, 28.8830128, -1625.48047,
    -0.500477076, 0.244971365, -0.830368519,
    0.00281524379, 0.959587574, 0.28139618,
    0.865745246, 0.138494655, -0.480941236
)

-- // TRAIN RIDING STATE \\ --
local isOnTrain = false
local trainBoardTime = 0

-- // TRAIN FUNCTIONS \\ --
local function getInTrain()
    pcall(function()
        local winterSeats = workspace:FindFirstChild("WinterTrainSeats")
        if winterSeats then
            local seat = winterSeats:FindFirstChild("Seat")
            if seat then
                local args = {{ carriage = seat }}
                local adoptmeNet = game:GetService("ReplicatedStorage"):FindFirstChild("adoptme_new_net")
                if adoptmeNet then
                    local trainNet = adoptmeNet:FindFirstChild("adoptme_legacy_shared.ContentPacks.Winter2025.Game.Train.WinterTrainNet:7")
                    if trainNet then
                        trainNet:FireServer(unpack(args))
                    end
                end
            end
        end
    end)
end

local function jumpOutTrain()
    print("[Train] Jumping out...")

    -- Method 1: Force Sit property (Confirmed working)
    pcall(function()
        if character and character:FindFirstChild("Humanoid") then
            character.Humanoid.Sit = false
            character.Humanoid.Jump = true
        end
    end)
    
    -- Wait briefly to see if it worked
    task.wait(0.5)

    -- Method 2: Force Teleport Upwards (Fallback if still sitting)
    pcall(function()
        if character and character:FindFirstChild("Humanoid") and character.Humanoid.Sit then
            print("[Train] Stuck in seat? Force teleporting up.")
            if hrp then
                hrp.CFrame = hrp.CFrame + Vector3.new(0, 5, 0)
            end
        end
    end)
end

local function hasGingerbreadAvailable()
    if not mainMap then return false end
    
    for _, item in pairs(mainMap:GetDescendants()) do
        if item.Name == "GingerbreadMan" then
            return true
        end
    end
    
    return false
end

-- // HELPER FUNCTIONS \\ --
local function formatTime(seconds)
    local hours = math.floor(seconds / 3600)
    local minutes = math.floor((seconds % 3600) / 60)
    local secs = math.floor(seconds % 60)
    return string.format("%02d:%02d:%02d", hours, minutes, secs)
end

-- // GUI CREATION \\ --
local ScreenGui = Instance.new("ScreenGui")
local MainFrame = Instance.new("Frame")
local Title = Instance.new("TextLabel")
local ToggleButton = Instance.new("TextButton")
local WebhookInput = Instance.new("TextBox")
local StatsFrame = Instance.new("Frame")
local StatCurrent = Instance.new("TextLabel")
local StatSession = Instance.new("TextLabel")
local StatFromCollection = Instance.new("TextLabel")
local StatFromTrain = Instance.new("TextLabel")
local StatTime = Instance.new("TextLabel")
local UICorner = Instance.new("UICorner")
local UIStroke = Instance.new("UIStroke") -- Add stroke for outline
local TitleCorner = Instance.new("UICorner")

-- Protect GUI
if syn and syn.protect_gui then
    syn.protect_gui(ScreenGui)
    ScreenGui.Parent = CoreGui
elseif gethui then
    ScreenGui.Parent = gethui()
else
    ScreenGui.Parent = CoreGui
end

ScreenGui.Name = "GingerbreadFarmGUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.IgnoreGuiInset = true 
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- Constants for Theme
local THEME = {
    Background = Color3.fromRGB(25, 25, 30),
    Accent = Color3.fromRGB(255, 140, 0), -- Gingerbread Orange
    Secondary = Color3.fromRGB(40, 40, 45),
    Text = Color3.fromRGB(240, 240, 240),
    Success = Color3.fromRGB(100, 255, 100),
    Fail = Color3.fromRGB(255, 100, 100)
}

-- Main Background
MainFrame.Name = "MainFrame"
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = THEME.Background
MainFrame.Position = UDim2.new(0.5, -150, 0.5, -175)
MainFrame.Size = UDim2.new(0, 300, 0, 360)
MainFrame.Active = true
MainFrame.Draggable = true 
MainFrame.ZIndex = 105 -- Keep UI above Black Screen
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 10)

UIStroke.Parent = MainFrame
UIStroke.Color = THEME.Accent
UIStroke.Thickness = 2

-- Title
Title.Name = "Title"
Title.Parent = MainFrame
Title.BackgroundColor3 = THEME.Accent
Title.Size = UDim2.new(1, 0, 0, 40)
Title.Font = Enum.Font.GothamBold
Title.Text = "GINGERBREAD FARM"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 18
TitleCorner.CornerRadius = UDim.new(0, 10)
TitleCorner.Parent = Title

-- Fix bottom corners of title to be straight (cover with a frame or just ignore for simple look)
-- Let's just keep it rounded, looks bubbly.

-- Toggle Button
ToggleButton.Name = "ToggleButton"
ToggleButton.Parent = MainFrame
ToggleButton.BackgroundColor3 = THEME.Fail -- Start red
ToggleButton.Position = UDim2.new(0.1, 0, 0.15, 0)
ToggleButton.Size = UDim2.new(0.8, 0, 0, 45)
ToggleButton.Font = Enum.Font.GothamBlack
ToggleButton.Text = "START FARMING"
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.TextSize = 20
Instance.new("UICorner", ToggleButton).CornerRadius = UDim.new(0, 8)

-- Webhook Input
WebhookInput.Name = "WebhookInput"
WebhookInput.Parent = MainFrame
WebhookInput.BackgroundColor3 = THEME.Secondary
WebhookInput.Position = UDim2.new(0.1, 0, 0.32, 0)
WebhookInput.Size = UDim2.new(0.8, 0, 0, 35)
WebhookInput.Font = Enum.Font.Gotham
WebhookInput.PlaceholderText = "Paste Discord Webhook URL..."
WebhookInput.Text = webhookUrl 
WebhookInput.TextColor3 = THEME.Text
WebhookInput.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
WebhookInput.TextSize = 12
WebhookInput.TextScaled = false
WebhookInput.TextWrapped = false -- Don't wrap lines
WebhookInput.ClipsDescendants = true -- Prevent text from spilling out
Instance.new("UICorner", WebhookInput).CornerRadius = UDim.new(0, 8)
local WebhookStroke = Instance.new("UIStroke")
WebhookStroke.Parent = WebhookInput
WebhookStroke.Color = Color3.fromRGB(60, 60, 60)
WebhookStroke.Thickness = 1

-- Stats Frame
StatsFrame.Name = "StatsFrame"
StatsFrame.Parent = MainFrame
StatsFrame.BackgroundColor3 = THEME.Secondary
StatsFrame.Position = UDim2.new(0.05, 0, 0.45, 0)
StatsFrame.Size = UDim2.new(0.9, 0, 0, 180) 
Instance.new("UICorner", StatsFrame).CornerRadius = UDim.new(0, 8)
local StatsStroke = Instance.new("UIStroke")
StatsStroke.Parent = StatsFrame
StatsStroke.Color = Color3.fromRGB(60, 60, 60)
StatsStroke.Thickness = 1

-- Stats Config
local function createStatLabel(name, text, posY, color)
    local label = Instance.new("TextLabel")
    label.Name = name
    label.Parent = StatsFrame
    label.BackgroundTransparency = 1
    label.Position = UDim2.new(0.05, 0, 0, posY)
    label.Size = UDim2.new(0.9, 0, 0, 25)
    label.Font = Enum.Font.GothamSemibold
    label.Text = text
    label.TextColor3 = color or THEME.Text
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.TextSize = 14
    return label
end

StatCurrent = createStatLabel("StatCurrent", "Current: N/A", 10, Color3.fromRGB(255, 215, 0))
StatSession = createStatLabel("StatSession", "Gained: 0", 40, Color3.fromRGB(0, 255, 127))
StatFromCollection = createStatLabel("StatFromCollection", "From Collection: 0", 70, Color3.fromRGB(255, 160, 122))
StatFromTrain = createStatLabel("StatFromTrain", "From Train: 0", 100, Color3.fromRGB(135, 206, 250))
StatTime = createStatLabel("StatTime", "Time: 00:00:00", 140, Color3.fromRGB(200, 200, 200))

-- // CPU LIMITER & SETTINGS UI \\ --
local SettingsOpen = false

-- Settings Button
local SettingsBtn = Instance.new("TextButton")
SettingsBtn.Name = "SettingsBtn"
SettingsBtn.Parent = MainFrame
SettingsBtn.BackgroundColor3 = THEME.Secondary
SettingsBtn.Position = UDim2.new(0.85, 0, 0, 5) 
SettingsBtn.Size = UDim2.new(0, 30, 0, 30)
SettingsBtn.Font = Enum.Font.GothamBold
SettingsBtn.Text = "S"
SettingsBtn.TextColor3 = THEME.Text
SettingsBtn.TextSize = 20
SettingsBtn.ZIndex = 106 -- Ensure on top
Instance.new("UICorner", SettingsBtn).CornerRadius = UDim.new(0, 6)

-- Limiter Frame
local LimiterFrame = Instance.new("Frame")
LimiterFrame.Name = "LimiterFrame"
LimiterFrame.Parent = MainFrame -- Docked to MainFrame
LimiterFrame.BackgroundColor3 = THEME.Background
LimiterFrame.Position = UDim2.new(1, 10, 0, 0) -- Attached to right side
LimiterFrame.Size = UDim2.new(0, 200, 0, 220)
LimiterFrame.Visible = false
LimiterFrame.ZIndex = 106 -- Keep Settings above Black Screen
Instance.new("UICorner", LimiterFrame).CornerRadius = UDim.new(0, 10)
local LimiterStroke = Instance.new("UIStroke")
LimiterStroke.Parent = LimiterFrame
LimiterStroke.Color = THEME.Accent
LimiterStroke.Thickness = 2

local LimiterTitle = Instance.new("TextLabel")
LimiterTitle.Parent = LimiterFrame
LimiterTitle.BackgroundTransparency = 1
LimiterTitle.Size = UDim2.new(1, 0, 0, 40)
LimiterTitle.Font = Enum.Font.GothamBold
LimiterTitle.Text = "CPU SETTINGS"
LimiterTitle.TextColor3 = THEME.Text
LimiterTitle.TextSize = 16

-- Black Screen Toggle
local BlackScreenBtn = Instance.new("TextButton")
BlackScreenBtn.Name = "BlackScreenBtn"
BlackScreenBtn.Parent = LimiterFrame
BlackScreenBtn.BackgroundColor3 = THEME.Secondary
BlackScreenBtn.Position = UDim2.new(0.1, 0, 0.2, 0)
BlackScreenBtn.Size = UDim2.new(0.8, 0, 0, 40)
BlackScreenBtn.Font = Enum.Font.GothamSemibold
BlackScreenBtn.Text = "Low Power Mode\n(OFF)"
BlackScreenBtn.TextColor3 = THEME.Text
BlackScreenBtn.TextSize = 12
Instance.new("UICorner", BlackScreenBtn).CornerRadius = UDim.new(0, 8)

-- FPS Slider
local SliderLabel = Instance.new("TextLabel")
SliderLabel.Parent = LimiterFrame
SliderLabel.BackgroundTransparency = 1
SliderLabel.Position = UDim2.new(0.1, 0, 0.45, 0)
SliderLabel.Size = UDim2.new(0.8, 0, 0, 20)
SliderLabel.Font = Enum.Font.Gotham
SliderLabel.Text = "FPS Limit: 10"
SliderLabel.TextColor3 = THEME.Text
SliderLabel.TextSize = 14
SliderLabel.TextXAlignment = Enum.TextXAlignment.Left

local SliderBg = Instance.new("Frame")
SliderBg.Name = "SliderBg"
SliderBg.Parent = LimiterFrame
SliderBg.BackgroundColor3 = THEME.Secondary
SliderBg.Position = UDim2.new(0.1, 0, 0.55, 0)
SliderBg.Size = UDim2.new(0.8, 0, 0, 8)
Instance.new("UICorner", SliderBg).CornerRadius = UDim.new(1, 0)

local SliderBtn = Instance.new("TextButton")
SliderBtn.Name = "SliderBtn"
SliderBtn.Parent = SliderBg
SliderBtn.BackgroundColor3 = THEME.Accent
SliderBtn.Position = UDim2.new(9/59, -8, 0.5, -8) -- Start at 10 FPS
SliderBtn.Size = UDim2.new(0, 16, 0, 16)
SliderBtn.Text = ""
Instance.new("UICorner", SliderBtn).CornerRadius = UDim.new(1, 0)

-- Black Overlay
local BlackOverlay = Instance.new("Frame")
BlackOverlay.Name = "BlackOverlay"
BlackOverlay.Parent = ScreenGui
BlackOverlay.BackgroundColor3 = Color3.new(0, 0, 0)
BlackOverlay.Size = UDim2.new(1, 0, 1, 0)
BlackOverlay.Visible = false
BlackOverlay.ZIndex = 100
local BlackOverlayText = Instance.new("TextLabel")
BlackOverlayText.Parent = BlackOverlay
BlackOverlayText.BackgroundTransparency = 1
BlackOverlayText.Size = UDim2.new(1, 0, 1, 0)
BlackOverlayText.Font = Enum.Font.GothamBold
BlackOverlayText.Text = "LOW POWER MODE ACTIVE\nTap/Click Center or Toggle to Disable"
BlackOverlayText.TextColor3 = Color3.fromRGB(150, 150, 150)
BlackOverlayText.TextSize = 24

local OverlayButton = Instance.new("TextButton") -- Invisible button to toggle off
OverlayButton.Parent = BlackOverlay
OverlayButton.BackgroundTransparency = 1
OverlayButton.Size = UDim2.new(1,0,1,0)
OverlayButton.Text = ""
OverlayButton.ZIndex = 101

-- // LOGIC FOR CPU LIMITER \\ --

-- Toggle Settings Panel
SettingsBtn.MouseButton1Click:Connect(function()
    SettingsOpen = not SettingsOpen
    LimiterFrame.Visible = SettingsOpen
end)

-- FPS Slider
local draggingSlider = false
local currentFPSLimit = 10

local function updateSlider(input)
    local sliderX = SliderBg.AbsolutePosition.X
    local sliderWidth = SliderBg.AbsoluteSize.X
    local inputX = input.Position.X
    
    local relativeX = math.clamp((inputX - sliderX) / sliderWidth, 0, 1)
    
    SliderBtn.Position = UDim2.new(relativeX, -8, 0.5, -8)
    
    local fps = math.floor((relativeX * 59) + 1)
    currentFPSLimit = fps
    SliderLabel.Text = "FPS Limit: " .. tostring(fps)
    
    if isLowPower and setfpscap then 
        setfpscap(fps) 
    end
end

SliderBtn.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        draggingSlider = true
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if draggingSlider and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        updateSlider(input)
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        draggingSlider = false
    end
end)

-- Low Power Mode
local isLowPower = false
local function toggleLowPower()
    isLowPower = not isLowPower
    BlackScreenBtn.Text = isLowPower and "Low Power Mode\n(ON)" or "Low Power Mode\n(OFF)"
    BlackScreenBtn.BackgroundColor3 = isLowPower and THEME.Success or THEME.Secondary
    BlackOverlay.Visible = isLowPower
    
    if isLowPower then
        -- Enable Low Power
        pcall(function() RunService:Set3dRenderingEnabled(false) end)
        if setfpscap then setfpscap(currentFPSLimit) end 
        
    else
        -- Disable Low Power
        pcall(function() RunService:Set3dRenderingEnabled(true) end)
        if setfpscap then setfpscap(60) end -- Restore to standard 60
    end
end

BlackScreenBtn.MouseButton1Click:Connect(toggleLowPower)
OverlayButton.MouseButton1Click:Connect(toggleLowPower)

-- // GUI LOGIC UPDATE \\ --
ToggleButton.MouseButton1Click:Connect(function()
    getgenv().g_autofarmgingerbread = not getgenv().g_autofarmgingerbread
    
    if getgenv().g_autofarmgingerbread then
        ToggleButton.Text = "STOP FARMING"
        ToggleButton.BackgroundColor3 = THEME.Success
    else
        ToggleButton.Text = "START FARMING"
        ToggleButton.BackgroundColor3 = THEME.Fail
    end
end)

WebHookInput = Instance.new("TextBox") -- Fix reference if needed, but context is fine.

-- // KEYBINDS \\ --
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == Enum.KeyCode.E then
        -- Toggle Farm
        getgenv().g_autofarmgingerbread = not getgenv().g_autofarmgingerbread
        
        if getgenv().g_autofarmgingerbread then
            ToggleButton.Text = "STOP FARMING"
            ToggleButton.BackgroundColor3 = THEME.Success
        else
            ToggleButton.Text = "START FARMING"
            ToggleButton.BackgroundColor3 = THEME.Fail
        end
        
    elseif input.KeyCode == Enum.KeyCode.T then
        -- Toggle CPU Limiter (Low Power Mode)
        if toggleLowPower then
            toggleLowPower()
        end
    end
end)

WebhookInput.FocusLost:Connect(function()
    if WebhookInput.Text ~= "" then
        webhookUrl = WebhookInput.Text
        print("Webhook URL updated!")
    end
end)

-- // ANTI-AFK \\ --
player.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

-- // CHARACTER HANDLING \\ --
player.CharacterAdded:Connect(function(char)
    character = char
    hrp = character:WaitForChild("HumanoidRootPart")
end)

local function getCFrame(obj)
    if not obj then return nil end
    if obj:IsA("Model") then
        local pp = obj.PrimaryPart or obj:FindFirstChildWhichIsA("BasePart")
        if pp then return pp.CFrame end
    elseif obj:IsA("BasePart") then
        return obj.CFrame
    end
    return nil
end

local function rescanForNext()
    if not mainMap then return nil end
    for _, d in ipairs(mainMap:GetDescendants()) do
        if d.Name == "GingerbreadRig" then
            local gbm = d:FindFirstChild("GingerbreadMan", true)
            if gbm and gbm.Parent and not visited[gbm] then
                return gbm
            end
        end
    end
    return nil
end

-- // CURRENCY HELPERS \\ --

local function parseCurrencyString(str)
    if not str or str == "N/A" then return nil end
    local cleanStr = string.gsub(str, "%D", "")
    return tonumber(cleanStr)
end

local function getCurrencyText()
    local val = "N/A"
    pcall(function()
        val = player.PlayerGui.AltCurrencyIndicatorApp.CurrencyIndicator.Container.Amount.Text
    end)
    return val
end

-- // WEBHOOK SENDER \\ --
local function sendWebhook(amountText, gainedText)
    if not webhookUrl or webhookUrl == "" then return end
    
    local timeElapsed = tick() - startTime
    local timeString = formatTime(timeElapsed)

    local requestFunc = (syn and syn.request) or (http and http.request) or http_request or (fluxus and fluxus.request) or request
    
    if requestFunc then
        local embedData = {
            ["title"] = "Gingerbread Farm Status",
            ["description"] = "Running on Adopt Me!",
            ["color"] = tonumber(0xFFA500), -- Orange
            ["thumbnail"] = {
                ["url"] = "https://tr.rbxcdn.com/1d5b3064e62817351631525287313045/150/150/Image/Png"
            },
            ["fields"] = {
                { ["name"] = "Username", ["value"] = player.Name, ["inline"] = true },
                { ["name"] = "Current Total", ["value"] = "`" .. tostring(amountText) .. "`", ["inline"] = true },
                { ["name"] = "Gained Session", ["value"] = "`+" .. tostring(gainedText) .. "`", ["inline"] = true },
                { ["name"] = "", ["value"] = "", ["inline"] = false },
                { ["name"] = "From Collection", ["value"] = tostring(gainedFromCollection), ["inline"] = true },
                { ["name"] = "From Train", ["value"] = tostring(gainedFromTrain), ["inline"] = true },
                { ["name"] = "Time Elapsed", ["value"] = timeString, ["inline"] = false }
            },
            ["footer"] = {
                ["text"] = "Gingerbread Auto-Farm | " .. os.date("%X"),
                ["icon_url"] = "https://www.roblox.com/headshot-thumbnail/image?userId=" .. player.UserId .. "&width=420&height=420&format=png"
            }
        }

        pcall(function()
            requestFunc({
                Url = webhookUrl,
                Method = "POST", 
                Headers = { ['Content-Type'] = 'application/json' },
                Body = HttpService:JSONEncode({
                    ['username'] = "Gingerbread Bot",
                    ['avatar_url'] = "https://tr.rbxcdn.com/1d5b3064e62817351631525287313045/150/150/Image/Png",
                    ['embeds'] = { embedData }
                })
            })
        end)
    end
end

-- Webhook Loop
task.spawn(function()
    while true do
        task.wait(300) -- Send every 5 minutes
        if getgenv().g_autofarmgingerbread then
            sendWebhook(getCurrencyText(), gainedCurrency)
        end
    end
end)

-- // MAIN LOOP \\ --
while true do
    -- 1. Get raw string from GUI
    local currentRawText = getCurrencyText()
    
    -- 2. Convert to number for math
    local currentNum = parseCurrencyString(currentRawText)

    -- 3. Logic to handle Stats and Source Tracking
    if currentNum then
        if startCurrency == nil then
            startCurrency = currentNum
            lastTrackedCurrency = currentNum
        end
        
        -- Detect currency change and attribute to source
        if lastTrackedCurrency and currentNum > lastTrackedCurrency then
            local gained = currentNum - lastTrackedCurrency
            if currentSource == "collection" then
                gainedFromCollection = gainedFromCollection + gained
            elseif currentSource == "train" then
                gainedFromTrain = gainedFromTrain + gained
            end
        end
        lastTrackedCurrency = currentNum
        
        currentCurrencyValue = currentNum
        gainedCurrency = currentCurrencyValue - startCurrency
    end

    -- 4. Calculate Time
    local currentTimeElapsed = tick() - startTime

    -- 5. Update GUI Labels
    StatCurrent.Text = "Current: " .. currentRawText
    StatSession.Text = "Gained: " .. tostring(gainedCurrency)
    StatFromCollection.Text = "From Collection: " .. tostring(gainedFromCollection)
    StatFromTrain.Text = "From Train: " .. tostring(gainedFromTrain)
    StatTime.Text = "Time: " .. formatTime(currentTimeElapsed)

    -- 6. Farming Logic
    if getgenv().g_autofarmgingerbread then
        
        -- If on train, check for gingerbread respawn
        if isOnTrain then
            currentSource = "train" -- Track that we're earning from train
            if hasGingerbreadAvailable() then
                -- Gingerbread is back! Jump out of train and reset
                jumpOutTrain()
                isOnTrain = false
                currentSource = "none"
                visited = {} -- Reset visited table for new cycle
                current = nil
                didAutoCollectThisEmpty = false
                print("[Train] Gingerbread respawned! Jumping out to farm.")
                task.wait(1) -- Give a moment after jumping out
            end
        else
            -- Normal farming logic
            if current and (tick() - pickupStartTime > 5) then
                current = nil
            end

            if current and (not current.Parent) then
                current = nil
            end

            if not current then
                local nextTarget = rescanForNext()

                if nextTarget then
                    current = nextTarget
                    visited[current] = true 
                    pickupStartTime = tick()
                    
                    didAutoCollectThisEmpty = false
                    currentSource = "collection" -- Track as collection when picking up gingerbread

                    local cf = getCFrame(current)
                    if cf and hrp then
                        hrp.CFrame = cf
                    end
                else
                    -- No gingerbread available
                    if getgenv().g_autocollect and not didAutoCollectThisEmpty and hrp then
                        -- Step 1: Teleport to collection station
                        currentSource = "collection" -- Track that we're earning from collection
                        hrp.CFrame = collectCFrame
                        didAutoCollectThisEmpty = true
                        print("[Collect] Teleported to collection station.")
                        task.wait(2) -- Wait for collection to happen
                    elseif didAutoCollectThisEmpty and not isOnTrain then
                        -- Step 2: Get on the train after collecting
                        print("[Train] Getting on the Choo Choo Train!")
                        getInTrain()
                        isOnTrain = true
                        trainBoardTime = tick()
                    end
                end
            end
        end
    else
        -- If farming is disabled and we're on the train, get off
        if isOnTrain then
            jumpOutTrain()
            isOnTrain = false
        end
    end

    task.wait(0.1)
end
