print("Hello!!!!")

local Players = game:GetService("Players")
local Interiors = workspace:WaitForChild("Interiors")
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService("VirtualUser")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")

local mainMap = Interiors:WaitForChild("MainMap!Christmas")
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")

-- // CONFIGURATION DEFAULTS \\ --
getgenv().g_autofarmgingerbread = false 
getgenv().g_autocollect = true 
local webhookUrl = ""

local visited = {}
local current = nil
local pickupStartTime = 0 
local didAutoCollectThisEmpty = false

-- // CURRENCY TRACKING VARIABLES \\ --
local startCurrency = nil 
local currentCurrencyValue = 0
local gainedCurrency = 0
local lastTrackedCurrency = nil -- For detecting currency changes

-- // SOURCE TRACKING VARIABLES \\ --
local gainedFromCollection = 0
local gainedFromTrain = 0
local currentSource = "none" -- "collection", "train", or "none"

-- // TIME TRACKING VARIABLES \\ --
local startTime = tick() -- Records the exact time the script loaded

local collectCFrame = CFrame.new(
    -286.743164, 28.8830128, -1625.48047,
    -0.500477076, 0.244971365, -0.830368519,
    0.00281524379, 0.959587574, 0.28139618,
    0.865745246, 0.138494655, -0.480941236
)

-- // TRAIN RIDING STATE \\ --
local isOnTrain = false
local trainBoardTime = 0

-- // TRAIN FUNCTIONS \\ --
local function getInTrain()
    local args = {
        {
            carriage = workspace:WaitForChild("WinterTrainSeats"):WaitForChild("Seat")
        }
    }
    game:GetService("ReplicatedStorage"):WaitForChild("adoptme_new_net"):WaitForChild("adoptme_legacy_shared.ContentPacks.Winter2025.Game.Train.WinterTrainNet:7"):FireServer(unpack(args))
end

local function jumpOutTrain()
    game:GetService("ReplicatedStorage"):WaitForChild("API"):WaitForChild("QuFHMVlfXdWIUvHEYzaIcOd"):FireServer()
end

local function hasGingerbreadAvailable()
    for _, d in ipairs(mainMap:GetDescendants()) do
        if d.Name == "GingerbreadRig" then
            local gbm = d:FindFirstChild("GingerbreadMan", true)
            if gbm and gbm.Parent then
                return true
            end
        end
    end
    return false
end

-- // HELPER FUNCTIONS \\ --
local function formatTime(seconds)
    local hours = math.floor(seconds / 3600)
    local minutes = math.floor((seconds % 3600) / 60)
    local secs = math.floor(seconds % 60)
    return string.format("%02d:%02d:%02d", hours, minutes, secs)
end

-- // GUI CREATION \\ --
local ScreenGui = Instance.new("ScreenGui")
local MainFrame = Instance.new("Frame")
local Title = Instance.new("TextLabel")
local ToggleButton = Instance.new("TextButton")
local WebhookInput = Instance.new("TextBox")
local StatsFrame = Instance.new("Frame")
local StatCurrent = Instance.new("TextLabel")
local StatSession = Instance.new("TextLabel")
local StatFromCollection = Instance.new("TextLabel")
local StatFromTrain = Instance.new("TextLabel")
local StatTime = Instance.new("TextLabel")
local UICorner = Instance.new("UICorner")

-- Protect GUI
if syn and syn.protect_gui then
    syn.protect_gui(ScreenGui)
    ScreenGui.Parent = CoreGui
elseif gethui then
    ScreenGui.Parent = gethui()
else
    ScreenGui.Parent = CoreGui
end

ScreenGui.Name = "GingerbreadFarmGUI"
ScreenGui.ResetOnSpawn = false

-- Main Background
MainFrame.Name = "MainFrame"
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
MainFrame.Position = UDim2.new(0.5, -150, 0.5, -175) -- Adjusted height pos
MainFrame.Size = UDim2.new(0, 300, 0, 350) -- Increased size for more stats
MainFrame.Active = true
MainFrame.Draggable = true 
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 8)

-- Title
Title.Name = "Title"
Title.Parent = MainFrame
Title.BackgroundColor3 = Color3.fromRGB(255, 140, 0) 
Title.Size = UDim2.new(1, 0, 0, 30)
Title.Font = Enum.Font.GothamBold
Title.Text = "Gingerbread Auto-Farm"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 16
Instance.new("UICorner", Title).CornerRadius = UDim.new(0, 8)

-- Toggle Button
ToggleButton.Name = "ToggleButton"
ToggleButton.Parent = MainFrame
ToggleButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50) 
ToggleButton.Position = UDim2.new(0.1, 0, 0.18, 0)
ToggleButton.Size = UDim2.new(0.8, 0, 0, 40)
ToggleButton.Font = Enum.Font.GothamBold
ToggleButton.Text = "START FARMING"
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.TextSize = 18
Instance.new("UICorner", ToggleButton).CornerRadius = UDim.new(0, 6)

-- Webhook Input
WebhookInput.Name = "WebhookInput"
WebhookInput.Parent = MainFrame
WebhookInput.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
WebhookInput.Position = UDim2.new(0.1, 0, 0.38, 0)
WebhookInput.Size = UDim2.new(0.8, 0, 0, 30)
WebhookInput.Font = Enum.Font.Gotham
WebhookInput.PlaceholderText = "Paste Webhook URL Here"
WebhookInput.Text = webhookUrl 
WebhookInput.TextColor3 = Color3.fromRGB(200, 200, 200)
WebhookInput.TextSize = 12
WebhookInput.TextScaled = true
Instance.new("UICorner", WebhookInput).CornerRadius = UDim.new(0, 6)

-- Stats Frame
StatsFrame.Name = "StatsFrame"
StatsFrame.Parent = MainFrame
StatsFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
StatsFrame.Position = UDim2.new(0.1, 0, 0.42, 0)
StatsFrame.Size = UDim2.new(0.8, 0, 0, 170) -- Increased height for all stats
Instance.new("UICorner", StatsFrame).CornerRadius = UDim.new(0, 6)

-- Stat: Current
StatCurrent.Name = "StatCurrent"
StatCurrent.Parent = StatsFrame
StatCurrent.BackgroundTransparency = 1
StatCurrent.Position = UDim2.new(0, 10, 0, 10)
StatCurrent.Size = UDim2.new(1, -20, 0, 25)
StatCurrent.Font = Enum.Font.Gotham
StatCurrent.Text = "Current: N/A"
StatCurrent.TextColor3 = Color3.fromRGB(255, 255, 255)
StatCurrent.TextXAlignment = Enum.TextXAlignment.Left
StatCurrent.TextSize = 14

-- Stat: Session
StatSession.Name = "StatSession"
StatSession.Parent = StatsFrame
StatSession.BackgroundTransparency = 1
StatSession.Position = UDim2.new(0, 10, 0, 40)
StatSession.Size = UDim2.new(1, -20, 0, 25)
StatSession.Font = Enum.Font.Gotham
StatSession.Text = "Gained: 0"
StatSession.TextColor3 = Color3.fromRGB(255, 255, 255)
StatSession.TextXAlignment = Enum.TextXAlignment.Left
StatSession.TextSize = 14

-- Stat: From Collection
StatFromCollection.Name = "StatFromCollection"
StatFromCollection.Parent = StatsFrame
StatFromCollection.BackgroundTransparency = 1
StatFromCollection.Position = UDim2.new(0, 10, 0, 70)
StatFromCollection.Size = UDim2.new(1, -20, 0, 25)
StatFromCollection.Font = Enum.Font.Gotham
StatFromCollection.Text = "From Collection: 0"
StatFromCollection.TextColor3 = Color3.fromRGB(144, 238, 144) -- Light green
StatFromCollection.TextXAlignment = Enum.TextXAlignment.Left
StatFromCollection.TextSize = 14

-- Stat: From Train
StatFromTrain.Name = "StatFromTrain"
StatFromTrain.Parent = StatsFrame
StatFromTrain.BackgroundTransparency = 1
StatFromTrain.Position = UDim2.new(0, 10, 0, 100)
StatFromTrain.Size = UDim2.new(1, -20, 0, 25)
StatFromTrain.Font = Enum.Font.Gotham
StatFromTrain.Text = "From Train: 0"
StatFromTrain.TextColor3 = Color3.fromRGB(135, 206, 250) -- Light blue
StatFromTrain.TextXAlignment = Enum.TextXAlignment.Left
StatFromTrain.TextSize = 14

-- Stat: Time
StatTime.Name = "StatTime"
StatTime.Parent = StatsFrame
StatTime.BackgroundTransparency = 1
StatTime.Position = UDim2.new(0, 10, 0, 130)
StatTime.Size = UDim2.new(1, -20, 0, 25)
StatTime.Font = Enum.Font.Gotham
StatTime.Text = "Time: 00:00:00"
StatTime.TextColor3 = Color3.fromRGB(255, 255, 255)
StatTime.TextXAlignment = Enum.TextXAlignment.Left
StatTime.TextSize = 14

-- // GUI LOGIC \\ --

ToggleButton.MouseButton1Click:Connect(function()
    getgenv().g_autofarmgingerbread = not getgenv().g_autofarmgingerbread
    
    if getgenv().g_autofarmgingerbread then
        ToggleButton.Text = "STOP FARMING"
        ToggleButton.BackgroundColor3 = Color3.fromRGB(50, 200, 50) 
    else
        ToggleButton.Text = "START FARMING"
        ToggleButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50) 
    end
end)

WebhookInput.FocusLost:Connect(function()
    if WebhookInput.Text ~= "" then
        webhookUrl = WebhookInput.Text
        print("Webhook URL updated!")
    end
end)


-- // ANTI-AFK \\ --
player.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

-- // CHARACTER HANDLING \\ --
player.CharacterAdded:Connect(function(char)
    character = char
    hrp = character:WaitForChild("HumanoidRootPart")
end)

local function getCFrame(obj)
    if not obj then return nil end
    if obj:IsA("Model") then
        local pp = obj.PrimaryPart or obj:FindFirstChildWhichIsA("BasePart")
        if pp then return pp.CFrame end
    elseif obj:IsA("BasePart") then
        return obj.CFrame
    end
    return nil
end

local function rescanForNext()
    for _, d in ipairs(mainMap:GetDescendants()) do
        if d.Name == "GingerbreadRig" then
            local gbm = d:FindFirstChild("GingerbreadMan", true)
            if gbm and gbm.Parent and not visited[gbm] then
                return gbm
            end
        end
    end
    return nil
end

-- // CURRENCY HELPERS \\ --

local function parseCurrencyString(str)
    if not str or str == "N/A" then return nil end
    local cleanStr = string.gsub(str, "%D", "")
    return tonumber(cleanStr)
end

local function getCurrencyText()
    local val = "N/A"
    pcall(function()
        val = player.PlayerGui.AltCurrencyIndicatorApp.CurrencyIndicator.Container.Amount.Text
    end)
    return val
end

-- // WEBHOOK SENDER \\ --
local function sendWebhook(amountText, gainedText)
    if not webhookUrl or webhookUrl == "" then return end
    
    local timeElapsed = tick() - startTime
    local timeString = formatTime(timeElapsed)

    local requestFunc = (syn and syn.request) or (http and http.request) or http_request or (fluxus and fluxus.request) or request
    
    if requestFunc then
        requestFunc({
            Url = webhookUrl,
            Method = "POST", 
            Headers = { ['Content-Type'] = 'application/json' },
            Body = HttpService:JSONEncode({
                ['content'] = "",
                ['embeds'] = {{
                    ["title"] = "Gingerbread Status",
                    ["description"] = "Currency & Time Update",
                    ["type"] = "rich",
                    ["color"] = tonumber(0xffA500), 
                    ["fields"] = {
                        { ["name"] = "Current Total", ["value"] = tostring(amountText), ["inline"] = true },
                        { ["name"] = "Gained (Session)", ["value"] = tostring(gainedText), ["inline"] = true },
                        { ["name"] = "ðŸª From Collection", ["value"] = tostring(gainedFromCollection), ["inline"] = true },
                        { ["name"] = "ðŸš‚ From Train", ["value"] = tostring(gainedFromTrain), ["inline"] = true },
                        { ["name"] = "Time Elapsed", ["value"] = timeString, ["inline"] = false }
                    },
                    ["footer"] = { ["text"] = "Auto-Farm Script" }
                }}
            })
        })
    end
end

-- Webhook Loop
task.spawn(function()
    while true do
        task.wait(300) -- Send every 5 minutes
        if getgenv().g_autofarmgingerbread then
            sendWebhook(getCurrencyText(), gainedCurrency)
        end
    end
end)

-- // MAIN LOOP \\ --
while true do
    -- 1. Get raw string from GUI
    local currentRawText = getCurrencyText()
    
    -- 2. Convert to number for math
    local currentNum = parseCurrencyString(currentRawText)

    -- 3. Logic to handle Stats and Source Tracking
    if currentNum then
        if startCurrency == nil then
            startCurrency = currentNum
            lastTrackedCurrency = currentNum
        end
        
        -- Detect currency change and attribute to source
        if lastTrackedCurrency and currentNum > lastTrackedCurrency then
            local gained = currentNum - lastTrackedCurrency
            if currentSource == "collection" then
                gainedFromCollection = gainedFromCollection + gained
            elseif currentSource == "train" then
                gainedFromTrain = gainedFromTrain + gained
            end
        end
        lastTrackedCurrency = currentNum
        
        currentCurrencyValue = currentNum
        gainedCurrency = currentCurrencyValue - startCurrency
    end

    -- 4. Calculate Time
    local currentTimeElapsed = tick() - startTime

    -- 5. Update GUI Labels
    StatCurrent.Text = "Current: " .. currentRawText
    StatSession.Text = "Gained: " .. tostring(gainedCurrency)
    StatFromCollection.Text = "From Collection: " .. tostring(gainedFromCollection)
    StatFromTrain.Text = "From Train: " .. tostring(gainedFromTrain)
    StatTime.Text = "Time: " .. formatTime(currentTimeElapsed)

    -- 6. Farming Logic
    if getgenv().g_autofarmgingerbread then
        
        -- If on train, check for gingerbread respawn
        if isOnTrain then
            currentSource = "train" -- Track that we're earning from train
            if hasGingerbreadAvailable() then
                -- Gingerbread is back! Jump out of train and reset
                jumpOutTrain()
                isOnTrain = false
                currentSource = "none"
                visited = {} -- Reset visited table for new cycle
                current = nil
                didAutoCollectThisEmpty = false
                print("[Train] Gingerbread respawned! Jumping out to farm.")
                task.wait(1) -- Give a moment after jumping out
            end
        else
            -- Normal farming logic
            if current and (tick() - pickupStartTime > 5) then
                current = nil
            end

            if current and (not current.Parent) then
                current = nil
            end

            if not current then
                local nextTarget = rescanForNext()

                if nextTarget then
                    current = nextTarget
                    visited[current] = true 
                    pickupStartTime = tick()
                    
                    didAutoCollectThisEmpty = false

                    local cf = getCFrame(current)
                    if cf and hrp then
                        hrp.CFrame = cf
                    end
                else
                    -- No gingerbread available
                    if getgenv().g_autocollect and not didAutoCollectThisEmpty and hrp then
                        -- Step 1: Teleport to collection station
                        currentSource = "collection" -- Track that we're earning from collection
                        hrp.CFrame = collectCFrame
                        didAutoCollectThisEmpty = true
                        print("[Collect] Teleported to collection station.")
                        task.wait(2) -- Wait for collection to happen
                    elseif didAutoCollectThisEmpty and not isOnTrain then
                        -- Step 2: Get on the train after collecting
                        print("[Train] Getting on the Choo Choo Train!")
                        getInTrain()
                        isOnTrain = true
                        trainBoardTime = tick()
                    end
                end
            end
        end
    else
        -- If farming is disabled and we're on the train, get off
        if isOnTrain then
            jumpOutTrain()
            isOnTrain = false
        end
    end

    task.wait(0.1)
end
