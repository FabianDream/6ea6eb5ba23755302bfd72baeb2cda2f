print("Hello!!!!")

local Players = game:GetService("Players")
local Interiors = workspace:WaitForChild("Interiors")
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService("VirtualUser")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")

local mainMap = Interiors:WaitForChild("MainMap!Christmas")
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")

-- // CONFIGURATION DEFAULTS \\ --
getgenv().g_autofarmgingerbread = false 
getgenv().g_autocollect = true 
local webhookUrl = ""

local visited = {}
local current = nil
local pickupStartTime = 0 
local didAutoCollectThisEmpty = false

-- // CURRENCY TRACKING VARIABLES \\ --
local startCurrency = nil 
local currentCurrencyValue = 0
local gainedCurrency = 0
local lastTrackedCurrency = nil -- For detecting currency changes

-- // SOURCE TRACKING VARIABLES \\ --
local gainedFromCollection = 0
local gainedFromTrain = 0
local currentSource = "none" -- "collection", "train", or "none"

-- // TIME TRACKING VARIABLES \\ --
local startTime = tick() -- Records the exact time the script loaded

local collectCFrame = CFrame.new(
    -286.743164, 28.8830128, -1625.48047,
    -0.500477076, 0.244971365, -0.830368519,
    0.00281524379, 0.959587574, 0.28139618,
    0.865745246, 0.138494655, -0.480941236
)

-- // TRAIN RIDING STATE \\ --
local isOnTrain = false
local trainBoardTime = 0

-- // TRAIN FUNCTIONS \\ --
local function getInTrain()
    pcall(function()
        local winterSeats = workspace:FindFirstChild("WinterTrainSeats")
        if winterSeats then
            local seat = winterSeats:FindFirstChild("Seat")
            if seat then
                local args = {{ carriage = seat }}
                local adoptmeNet = game:GetService("ReplicatedStorage"):FindFirstChild("adoptme_new_net")
                if adoptmeNet then
                    local trainNet = adoptmeNet:FindFirstChild("adoptme_legacy_shared.ContentPacks.Winter2025.Game.Train.WinterTrainNet:7")
                    if trainNet then
                        trainNet:FireServer(unpack(args))
                    end
                end
            end
        end
    end)
end

local function jumpOutTrain()
    print("[Train] Jumping out...")

    -- Method 1: Force Sit property (Confirmed working)
    pcall(function()
        if character and character:FindFirstChild("Humanoid") then
            character.Humanoid.Sit = false
            character.Humanoid.Jump = true
        end
    end)
    
    -- Wait briefly to see if it worked
    task.wait(0.5)

    -- Method 2: Force Teleport Upwards (Fallback if still sitting)
    pcall(function()
        if character and character:FindFirstChild("Humanoid") and character.Humanoid.Sit then
            print("[Train] Stuck in seat? Force teleporting up.")
            if hrp then
                hrp.CFrame = hrp.CFrame + Vector3.new(0, 5, 0)
            end
        end
    end)
end

local function hasGingerbreadAvailable()
    for _, d in ipairs(mainMap:GetDescendants()) do
        if d.Name == "GingerbreadRig" then
            local gbm = d:FindFirstChild("GingerbreadMan", true)
            if gbm and gbm.Parent then
                return true
            end
        end
    end
    return false
end

-- // HELPER FUNCTIONS \\ --
local function formatTime(seconds)
    local hours = math.floor(seconds / 3600)
    local minutes = math.floor((seconds % 3600) / 60)
    local secs = math.floor(seconds % 60)
    return string.format("%02d:%02d:%02d", hours, minutes, secs)
end

-- // GUI CREATION \\ --
local ScreenGui = Instance.new("ScreenGui")
local MainFrame = Instance.new("Frame")
local Title = Instance.new("TextLabel")
local ToggleButton = Instance.new("TextButton")
local WebhookInput = Instance.new("TextBox")
local StatsFrame = Instance.new("Frame")
local StatCurrent = Instance.new("TextLabel")
local StatSession = Instance.new("TextLabel")
local StatFromCollection = Instance.new("TextLabel")
local StatFromTrain = Instance.new("TextLabel")
local StatTime = Instance.new("TextLabel")
local UICorner = Instance.new("UICorner")
local UIStroke = Instance.new("UIStroke") -- Add stroke for outline
local TitleCorner = Instance.new("UICorner")

-- Protect GUI
if syn and syn.protect_gui then
    syn.protect_gui(ScreenGui)
    ScreenGui.Parent = CoreGui
elseif gethui then
    ScreenGui.Parent = gethui()
else
    ScreenGui.Parent = CoreGui
end

ScreenGui.Name = "GingerbreadFarmGUI"
ScreenGui.ResetOnSpawn = false

-- Constants for Theme
local THEME = {
    Background = Color3.fromRGB(25, 25, 30),
    Accent = Color3.fromRGB(255, 140, 0), -- Gingerbread Orange
    Secondary = Color3.fromRGB(40, 40, 45),
    Text = Color3.fromRGB(240, 240, 240),
    Success = Color3.fromRGB(100, 255, 100),
    Fail = Color3.fromRGB(255, 100, 100)
}

-- Main Background
MainFrame.Name = "MainFrame"
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = THEME.Background
MainFrame.Position = UDim2.new(0.5, -150, 0.5, -175)
MainFrame.Size = UDim2.new(0, 300, 0, 360)
MainFrame.Active = true
MainFrame.Draggable = true 
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 10)

UIStroke.Parent = MainFrame
UIStroke.Color = THEME.Accent
UIStroke.Thickness = 2

-- Title
Title.Name = "Title"
Title.Parent = MainFrame
Title.BackgroundColor3 = THEME.Accent
Title.Size = UDim2.new(1, 0, 0, 40)
Title.Font = Enum.Font.GothamBold
Title.Text = "ðŸª GINGERBREAD FARM ðŸª"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 18
TitleCorner.CornerRadius = UDim.new(0, 10)
TitleCorner.Parent = Title

-- Fix bottom corners of title to be straight (cover with a frame or just ignore for simple look)
-- Let's just keep it rounded, looks bubbly.

-- Toggle Button
ToggleButton.Name = "ToggleButton"
ToggleButton.Parent = MainFrame
ToggleButton.BackgroundColor3 = THEME.Fail -- Start red
ToggleButton.Position = UDim2.new(0.1, 0, 0.15, 0)
ToggleButton.Size = UDim2.new(0.8, 0, 0, 45)
ToggleButton.Font = Enum.Font.GothamBlack
ToggleButton.Text = "START FARMING"
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.TextSize = 20
Instance.new("UICorner", ToggleButton).CornerRadius = UDim.new(0, 8)

-- Webhook Input
WebhookInput.Name = "WebhookInput"
WebhookInput.Parent = MainFrame
WebhookInput.BackgroundColor3 = THEME.Secondary
WebhookInput.Position = UDim2.new(0.1, 0, 0.32, 0)
WebhookInput.Size = UDim2.new(0.8, 0, 0, 35)
WebhookInput.Font = Enum.Font.Gotham
WebhookInput.PlaceholderText = "Paste Discord Webhook URL..."
WebhookInput.Text = webhookUrl 
WebhookInput.TextColor3 = THEME.Text
WebhookInput.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
WebhookInput.TextSize = 12
WebhookInput.TextScaled = false
WebhookInput.TextWrapped = false -- Don't wrap lines
WebhookInput.ClipsDescendants = true -- Prevent text from spilling out
Instance.new("UICorner", WebhookInput).CornerRadius = UDim.new(0, 8)
local WebhookStroke = Instance.new("UIStroke")
WebhookStroke.Parent = WebhookInput
WebhookStroke.Color = Color3.fromRGB(60, 60, 60)
WebhookStroke.Thickness = 1

-- Stats Frame
StatsFrame.Name = "StatsFrame"
StatsFrame.Parent = MainFrame
StatsFrame.BackgroundColor3 = THEME.Secondary
StatsFrame.Position = UDim2.new(0.05, 0, 0.45, 0)
StatsFrame.Size = UDim2.new(0.9, 0, 0, 180) 
Instance.new("UICorner", StatsFrame).CornerRadius = UDim.new(0, 8)
local StatsStroke = Instance.new("UIStroke")
StatsStroke.Parent = StatsFrame
StatsStroke.Color = Color3.fromRGB(60, 60, 60)
StatsStroke.Thickness = 1

-- Stats Config
local function createStatLabel(name, text, posY, color)
    local label = Instance.new("TextLabel")
    label.Name = name
    label.Parent = StatsFrame
    label.BackgroundTransparency = 1
    label.Position = UDim2.new(0.05, 0, 0, posY)
    label.Size = UDim2.new(0.9, 0, 0, 25)
    label.Font = Enum.Font.GothamSemibold
    label.Text = text
    label.TextColor3 = color or THEME.Text
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.TextSize = 14
    return label
end

StatCurrent = createStatLabel("StatCurrent", "ðŸ’° Current: N/A", 10, Color3.fromRGB(255, 215, 0))
StatSession = createStatLabel("StatSession", "ðŸ“ˆ Gained: 0", 40, Color3.fromRGB(0, 255, 127))
StatFromCollection = createStatLabel("StatFromCollection", "ðŸª From Collection: 0", 70, Color3.fromRGB(255, 160, 122))
StatFromTrain = createStatLabel("StatFromTrain", "ðŸš‚ From Train: 0", 100, Color3.fromRGB(135, 206, 250))
StatTime = createStatLabel("StatTime", "â± Time: 00:00:00", 140, Color3.fromRGB(200, 200, 200))

-- // GUI LOGIC UPDATE \\ --
ToggleButton.MouseButton1Click:Connect(function()
    getgenv().g_autofarmgingerbread = not getgenv().g_autofarmgingerbread
    
    if getgenv().g_autofarmgingerbread then
        ToggleButton.Text = "STOP FARMING"
        ToggleButton.BackgroundColor3 = THEME.Success
    else
        ToggleButton.Text = "START FARMING"
        ToggleButton.BackgroundColor3 = THEME.Fail
    end
end)

WebhookInput.FocusLost:Connect(function()
    if WebhookInput.Text ~= "" then
        webhookUrl = WebhookInput.Text
        print("Webhook URL updated!")
    end
end)

-- // ANTI-AFK \\ --
player.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

-- // CHARACTER HANDLING \\ --
player.CharacterAdded:Connect(function(char)
    character = char
    hrp = character:WaitForChild("HumanoidRootPart")
end)

local function getCFrame(obj)
    if not obj then return nil end
    if obj:IsA("Model") then
        local pp = obj.PrimaryPart or obj:FindFirstChildWhichIsA("BasePart")
        if pp then return pp.CFrame end
    elseif obj:IsA("BasePart") then
        return obj.CFrame
    end
    return nil
end

local function rescanForNext()
    for _, d in ipairs(mainMap:GetDescendants()) do
        if d.Name == "GingerbreadRig" then
            local gbm = d:FindFirstChild("GingerbreadMan", true)
            if gbm and gbm.Parent and not visited[gbm] then
                return gbm
            end
        end
    end
    return nil
end

-- // CURRENCY HELPERS \\ --

local function parseCurrencyString(str)
    if not str or str == "N/A" then return nil end
    local cleanStr = string.gsub(str, "%D", "")
    return tonumber(cleanStr)
end

local function getCurrencyText()
    local val = "N/A"
    pcall(function()
        val = player.PlayerGui.AltCurrencyIndicatorApp.CurrencyIndicator.Container.Amount.Text
    end)
    return val
end

-- // WEBHOOK SENDER \\ --
local function sendWebhook(amountText, gainedText)
    if not webhookUrl or webhookUrl == "" then return end
    
    local timeElapsed = tick() - startTime
    local timeString = formatTime(timeElapsed)

    local requestFunc = (syn and syn.request) or (http and http.request) or http_request or (fluxus and fluxus.request) or request
    
    if requestFunc then
        local embedData = {
            ["title"] = "ðŸª Gingerbread Farm Status",
            ["description"] = "Running on **Adopt Me!**",
            ["color"] = tonumber(0xFFA500), -- Orange
            ["thumbnail"] = {
                ["url"] = "https://tr.rbxcdn.com/1d5b3064e62817351631525287313045/150/150/Image/Png" -- Generic Adopt Me or Gingerbread icon
            },
            ["fields"] = {
                { ["name"] = "ï¿½ Username", ["value"] = player.Name, ["inline"] = true },
                { ["name"] = "ï¿½ðŸ’° Current Total", ["value"] = "`" .. tostring(amountText) .. "`", ["inline"] = true },
                { ["name"] = "ðŸ“ˆ Gained Session", ["value"] = "`+" .. tostring(gainedText) .. "`", ["inline"] = true },
                { ["name"] = "", ["value"] = "", ["inline"] = false }, -- Empty line force
                { ["name"] = "ðŸª From Collection", ["value"] = tostring(gainedFromCollection), ["inline"] = true },
                { ["name"] = "ðŸš‚ From Train", ["value"] = tostring(gainedFromTrain), ["inline"] = true },
                { ["name"] = "â± Time Elapsed", ["value"] = timeString, ["inline"] = false }
            },
            ["footer"] = {
                ["text"] = "Gingerbread Auto-Farm | " .. os.date("%X"),
                ["icon_url"] = "https://www.roblox.com/headshot-thumbnail/image?userId=" .. player.UserId .. "&width=420&height=420&format=png"
            }
        }

        pcall(function()
            requestFunc({
                Url = webhookUrl,
                Method = "POST", 
                Headers = { ['Content-Type'] = 'application/json' },
                Body = HttpService:JSONEncode({
                    ['username'] = "Gingerbread Bot",
                    ['avatar_url'] = "https://tr.rbxcdn.com/1d5b3064e62817351631525287313045/150/150/Image/Png",
                    ['embeds'] = { embedData }
                })
            })
        end)
    end
end

-- Webhook Loop
task.spawn(function()
    while true do
        task.wait(300) -- Send every 5 minutes
        if getgenv().g_autofarmgingerbread then
            sendWebhook(getCurrencyText(), gainedCurrency)
        end
    end
end)

-- // MAIN LOOP \\ --
while true do
    -- 1. Get raw string from GUI
    local currentRawText = getCurrencyText()
    
    -- 2. Convert to number for math
    local currentNum = parseCurrencyString(currentRawText)

    -- 3. Logic to handle Stats and Source Tracking
    if currentNum then
        if startCurrency == nil then
            startCurrency = currentNum
            lastTrackedCurrency = currentNum
        end
        
        -- Detect currency change and attribute to source
        if lastTrackedCurrency and currentNum > lastTrackedCurrency then
            local gained = currentNum - lastTrackedCurrency
            if currentSource == "collection" then
                gainedFromCollection = gainedFromCollection + gained
            elseif currentSource == "train" then
                gainedFromTrain = gainedFromTrain + gained
            end
        end
        lastTrackedCurrency = currentNum
        
        currentCurrencyValue = currentNum
        gainedCurrency = currentCurrencyValue - startCurrency
    end

    -- 4. Calculate Time
    local currentTimeElapsed = tick() - startTime

    -- 5. Update GUI Labels
    StatCurrent.Text = "Current: " .. currentRawText
    StatSession.Text = "Gained: " .. tostring(gainedCurrency)
    StatFromCollection.Text = "From Collection: " .. tostring(gainedFromCollection)
    StatFromTrain.Text = "From Train: " .. tostring(gainedFromTrain)
    StatTime.Text = "Time: " .. formatTime(currentTimeElapsed)

    -- 6. Farming Logic
    if getgenv().g_autofarmgingerbread then
        
        -- If on train, check for gingerbread respawn
        if isOnTrain then
            currentSource = "train" -- Track that we're earning from train
            if hasGingerbreadAvailable() then
                -- Gingerbread is back! Jump out of train and reset
                jumpOutTrain()
                isOnTrain = false
                currentSource = "none"
                visited = {} -- Reset visited table for new cycle
                current = nil
                didAutoCollectThisEmpty = false
                print("[Train] Gingerbread respawned! Jumping out to farm.")
                task.wait(1) -- Give a moment after jumping out
            end
        else
            -- Normal farming logic
            if current and (tick() - pickupStartTime > 5) then
                current = nil
            end

            if current and (not current.Parent) then
                current = nil
            end

            if not current then
                local nextTarget = rescanForNext()

                if nextTarget then
                    current = nextTarget
                    visited[current] = true 
                    pickupStartTime = tick()
                    
                    didAutoCollectThisEmpty = false
                    currentSource = "collection" -- Track as collection when picking up gingerbread

                    local cf = getCFrame(current)
                    if cf and hrp then
                        hrp.CFrame = cf
                    end
                else
                    -- No gingerbread available
                    if getgenv().g_autocollect and not didAutoCollectThisEmpty and hrp then
                        -- Step 1: Teleport to collection station
                        currentSource = "collection" -- Track that we're earning from collection
                        hrp.CFrame = collectCFrame
                        didAutoCollectThisEmpty = true
                        print("[Collect] Teleported to collection station.")
                        task.wait(2) -- Wait for collection to happen
                    elseif didAutoCollectThisEmpty and not isOnTrain then
                        -- Step 2: Get on the train after collecting
                        print("[Train] Getting on the Choo Choo Train!")
                        getInTrain()
                        isOnTrain = true
                        trainBoardTime = tick()
                    end
                end
            end
        end
    else
        -- If farming is disabled and we're on the train, get off
        if isOnTrain then
            jumpOutTrain()
            isOnTrain = false
        end
    end

    task.wait(0.1)
end
